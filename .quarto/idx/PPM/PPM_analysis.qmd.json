{"title":"PPM: Exploring 1^st^ order effects","markdown":{"yaml":{"title":"PPM: Exploring 1^st^ order effects","author":"Manny Gimond"},"headingText":"Loading the data into R","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE, small.mar=TRUE)\n\nknitr::knit_hooks$set(small.mar = function(before, options, envir) {\n    if (before) par(mar = c(3, 3, 1, .1))  \n})\n\n```\n\n------------------------------------------------------------------------\n\n[Data for this tutorial can be downloaded [from here](./data.zip). Don't forget to unzip the files to a dedicated folder on your computer.]{.block1}\n\n-----\n\n> Don't forget to set the R session to the project folder via *Session \\>\\> Set Working Directory \\>\\> Choose Directory*.\n\n-----\n\n\nFirst, we'll load the point pattern dataset, then we'll load two different raster datasets that will represent two separate 1^st^  order effects we suspect may help explain the distribution of stores within the study extent.\n\n```{r results='hide', warning=FALSE, message=FALSE}\n# Load packages\nlibrary(spatstat)\nlibrary(sf)\nlibrary(terra)\n\n# Read state polygon data\ns    <- st_read(\"MA.shp\")\nw    <- as.owin(s)\nw.km <- rescale.owin(w, 1000)\n\n# Read Walmart point data\ns    <- st_read(\"Walmarts.shp\")\np    <- as.ppp(s)\np.km <- rescale.ppp(p, 1000)\nmarks(p.km)  <- NULL\nWindow(p.km) <- w.km\n\n# Read population density raster\nimg     <- rast(\"log_pop_sqmile.tif\")\ndf      <- as.data.frame(img, xy = TRUE)\npop     <- as.im(df)\npop.km  <- rescale.im(pop, 1000)\n\n# Read median income raster\nimg      <- rast(\"median_income.tif\")\ndf       <- as.data.frame(img, xy = TRUE)\ninc      <- as.im(df)\ninc.km   <- rescale.im(inc, 1000)\n```\n\nNote that later in the script, we will make use of the `effectfun()` that requires that the raster layer be stored as a double data type. You can tell if your raster is stored as a double by typing `typeof(inc.km[])`, for example. If it's not stored as a double, you can force it to a double using the `as.double()` function (e.g. `inc[] <- as.double(inc[])`). \n\nLet's plot each raster with the Walmart point overlay. We'll use `R`'s base plotting environment.\n\n```{r fig.height=3, small.mar = TRUE, fig.show='hold', echo = 2:7}\nOP <- par(mfrow = c(1,2), mar=c(2,0,2,0)) # This creates a two-pane plotting window\n\nplot(pop.km, ribside=\"bottom\", main=\"Population (log)\")\nplot(p.km, pch = 20, col=rgb(1,1,1,0.5), add=TRUE)\n\nplot(inc.km, ribside=\"bottom\", main=\"Income\")\nplot(p.km, pch = 20, col=rgb(1,1,1,0.6), add=TRUE)\n\npar(OP)\n```\n\n## Modeling point density as a function of two competing covariates: population density and income.\n\nWe will first develop two different models that we think might define the Walmart's point intensity. Recall that *intensity* is a property of the underlying \"process\" (one being defined by the distribution of population density and the other being defined by the distribution of income)--this differs from *density* which is associated with the observed pattern. These models are represented in our R script by two raster layers: a population raster and an income raster. These models will be  **alternate** models that we'll denote as `Mpop` and `Minc` in the script. The models' structure will follow the form of a logistics model, but note that the models can take on many different forms and different levels of complexity.\n\nWe'll also create the null model, `Mo`, which will assume a **spatially uniform** (homogeneous) covariate. In other words, `Mo` will define the model where the intensity of the process is assumed to be the same across the entire study extent.\n\n```{r}\nMpop <- ppm(p.km ~ pop.km) # Population model\nMinc <- ppm(p.km ~ inc.km) # Income model\nMo   <- ppm(p.km ~ 1)      # Null model\n```\n\nLet's explore the model parameters. First, we'll look at `Mpop`.\n\n```{r}\nMpop\n```\n\nThe values of interest are the **intercept** (whose value is around `-10.1`) and the **coefficient** `pop.km` (whose value is around `0.63`). Using these values, we can construct the mathematical relationship (noting that we are using the logged population raster and not the original population raster values):\n\n$$\nWalmart\\ intensity(i)= e^{−10.1 + 0.63\\ log(population\\ density_i)}\n$$ The above equation can be interpreted as follows: if the population density is `0`, then the Walmart intensity is $e^{−10.1}$ which is very close to `0`. So for every unit increase of the *logged* population density (i.e. log of one person per square mile), there is an increase in Walmart intensity by a factor of $e^{0.63}$.\n\nLikewise, we can extract the parameters from the `Minc` model and construct its equation.\n\n```{r}\nMinc\n```\n\n$$\nWalmart\\ intensity(i) = e^{−5.58\\ −1.66e^{−5}\\ Income(i)}\n$$ Note the negative (decreasing) relationship between income distribution and Walmart density.\n\nNext, we'll extract the null model results:\n\n```{r}\nMo\n```\n\nThis gives us the following equation for the homogeneous process:\n\n$$\nWalmart\\ intensity(i) = e^{−6.17} = 0.00209\n$$\n\nwhich is nothing more than the number of stores per unit area (44 stores / 21,000km^2^ = 0.00209).\n\n## Plotting the competing models\n\n```{r fig.show='hold', fig.height=3, small.mar =TRUE}\nOP <- par(mfrow = c(1,2), mar = c(4,4,2,1))  # This creates a two-pane plotting window\n\nplot(effectfun(Mpop, \"pop.km\", se.fit = TRUE), main = \"Population\",\n     ylab = \"Walmarts per km2\", xlab = \"Population density\", legend = FALSE)\n\nplot(effectfun(Minc, \"inc.km\", se.fit = TRUE), main = \"Income\",\n     ylab = \"Walmarts per km2\", xlab = \"Income\", legend = FALSE)\n\npar(OP) # This reverts our plot window back to a one-pane window\n```\n\nNote the difference in relationships between the two models. In the first plot, we note an increasing relationship between Walmart intensity and population density; this is to be expected since you would not expect to see Walmart stores in underpopulated areas. In the second plot, we note an inverse relationship between Walmart intensity and income---i.e. as an area's income increases, the Walmart intensity decreases.\n\nThe grey envelopes encompass the 95% confidence interval; i.e. the true estimate (black line) can fall anywhere within this envelope. Note how the envelope broadens near the upper end of the population density values--this suggests wide uncertainty in the estimated model.\n\nTo assess how well the above models explain the relationship between covariate and Walmart intensity, we will turn to hypothesis testing.\n\n## Testing for covariate effect\n\nNow, let's compare the non-homogeneous covariates to the null model using a technique called the *likelihood ratio* test. Remember that the null model assumes that the intensity is homogeneous across the entire study area; what we want to know is *\"does the model with the covariate do a significantly better job in predicting Walmart densities than the null model?\"*\n\n```{r}\nanova(Mo, Mpop, test = \"LRT\") # Compare null to population model\n```\n\n```{r}\nanova(Mo, Minc, test = \"LRT\") # Compare null to income model\n```\n\nWhat we are seeking is a small p-value (parameter `Pr(>Chi)` in the output). The smaller the value, the more confident we are in stating that the covariate does a better job in predicting Walmart intensity than the null model. For example, the p-value for the `Mpop` model (`Pr(>Chi) = 1.776e-08`) suggests that population density does a better job in predicting Walmart density than the null model `Mo`.\n\nThe p-value for `Minc`, on the other hand, is higher with a value of `Pr = 0.247` indicating that there is a 24.7% chance that we would be wrong in stating that income does a better job in predicting Walmart densities. To many, that probability is too high to reject the null.\n\nSo to summaries: of the two models we tested, it seems that population density does a better job at explaining the distribution of Walmarts (though not perfect) than the null model. Income distribution, on the other hand, does not improve on the null model.\n\n\n","srcMarkdownNoYaml":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE, small.mar=TRUE)\n\nknitr::knit_hooks$set(small.mar = function(before, options, envir) {\n    if (before) par(mar = c(3, 3, 1, .1))  \n})\n\n```\n\n------------------------------------------------------------------------\n\n[Data for this tutorial can be downloaded [from here](./data.zip). Don't forget to unzip the files to a dedicated folder on your computer.]{.block1}\n\n-----\n\n> Don't forget to set the R session to the project folder via *Session \\>\\> Set Working Directory \\>\\> Choose Directory*.\n\n-----\n\n## Loading the data into R\n\nFirst, we'll load the point pattern dataset, then we'll load two different raster datasets that will represent two separate 1^st^  order effects we suspect may help explain the distribution of stores within the study extent.\n\n```{r results='hide', warning=FALSE, message=FALSE}\n# Load packages\nlibrary(spatstat)\nlibrary(sf)\nlibrary(terra)\n\n# Read state polygon data\ns    <- st_read(\"MA.shp\")\nw    <- as.owin(s)\nw.km <- rescale.owin(w, 1000)\n\n# Read Walmart point data\ns    <- st_read(\"Walmarts.shp\")\np    <- as.ppp(s)\np.km <- rescale.ppp(p, 1000)\nmarks(p.km)  <- NULL\nWindow(p.km) <- w.km\n\n# Read population density raster\nimg     <- rast(\"log_pop_sqmile.tif\")\ndf      <- as.data.frame(img, xy = TRUE)\npop     <- as.im(df)\npop.km  <- rescale.im(pop, 1000)\n\n# Read median income raster\nimg      <- rast(\"median_income.tif\")\ndf       <- as.data.frame(img, xy = TRUE)\ninc      <- as.im(df)\ninc.km   <- rescale.im(inc, 1000)\n```\n\nNote that later in the script, we will make use of the `effectfun()` that requires that the raster layer be stored as a double data type. You can tell if your raster is stored as a double by typing `typeof(inc.km[])`, for example. If it's not stored as a double, you can force it to a double using the `as.double()` function (e.g. `inc[] <- as.double(inc[])`). \n\nLet's plot each raster with the Walmart point overlay. We'll use `R`'s base plotting environment.\n\n```{r fig.height=3, small.mar = TRUE, fig.show='hold', echo = 2:7}\nOP <- par(mfrow = c(1,2), mar=c(2,0,2,0)) # This creates a two-pane plotting window\n\nplot(pop.km, ribside=\"bottom\", main=\"Population (log)\")\nplot(p.km, pch = 20, col=rgb(1,1,1,0.5), add=TRUE)\n\nplot(inc.km, ribside=\"bottom\", main=\"Income\")\nplot(p.km, pch = 20, col=rgb(1,1,1,0.6), add=TRUE)\n\npar(OP)\n```\n\n## Modeling point density as a function of two competing covariates: population density and income.\n\nWe will first develop two different models that we think might define the Walmart's point intensity. Recall that *intensity* is a property of the underlying \"process\" (one being defined by the distribution of population density and the other being defined by the distribution of income)--this differs from *density* which is associated with the observed pattern. These models are represented in our R script by two raster layers: a population raster and an income raster. These models will be  **alternate** models that we'll denote as `Mpop` and `Minc` in the script. The models' structure will follow the form of a logistics model, but note that the models can take on many different forms and different levels of complexity.\n\nWe'll also create the null model, `Mo`, which will assume a **spatially uniform** (homogeneous) covariate. In other words, `Mo` will define the model where the intensity of the process is assumed to be the same across the entire study extent.\n\n```{r}\nMpop <- ppm(p.km ~ pop.km) # Population model\nMinc <- ppm(p.km ~ inc.km) # Income model\nMo   <- ppm(p.km ~ 1)      # Null model\n```\n\nLet's explore the model parameters. First, we'll look at `Mpop`.\n\n```{r}\nMpop\n```\n\nThe values of interest are the **intercept** (whose value is around `-10.1`) and the **coefficient** `pop.km` (whose value is around `0.63`). Using these values, we can construct the mathematical relationship (noting that we are using the logged population raster and not the original population raster values):\n\n$$\nWalmart\\ intensity(i)= e^{−10.1 + 0.63\\ log(population\\ density_i)}\n$$ The above equation can be interpreted as follows: if the population density is `0`, then the Walmart intensity is $e^{−10.1}$ which is very close to `0`. So for every unit increase of the *logged* population density (i.e. log of one person per square mile), there is an increase in Walmart intensity by a factor of $e^{0.63}$.\n\nLikewise, we can extract the parameters from the `Minc` model and construct its equation.\n\n```{r}\nMinc\n```\n\n$$\nWalmart\\ intensity(i) = e^{−5.58\\ −1.66e^{−5}\\ Income(i)}\n$$ Note the negative (decreasing) relationship between income distribution and Walmart density.\n\nNext, we'll extract the null model results:\n\n```{r}\nMo\n```\n\nThis gives us the following equation for the homogeneous process:\n\n$$\nWalmart\\ intensity(i) = e^{−6.17} = 0.00209\n$$\n\nwhich is nothing more than the number of stores per unit area (44 stores / 21,000km^2^ = 0.00209).\n\n## Plotting the competing models\n\n```{r fig.show='hold', fig.height=3, small.mar =TRUE}\nOP <- par(mfrow = c(1,2), mar = c(4,4,2,1))  # This creates a two-pane plotting window\n\nplot(effectfun(Mpop, \"pop.km\", se.fit = TRUE), main = \"Population\",\n     ylab = \"Walmarts per km2\", xlab = \"Population density\", legend = FALSE)\n\nplot(effectfun(Minc, \"inc.km\", se.fit = TRUE), main = \"Income\",\n     ylab = \"Walmarts per km2\", xlab = \"Income\", legend = FALSE)\n\npar(OP) # This reverts our plot window back to a one-pane window\n```\n\nNote the difference in relationships between the two models. In the first plot, we note an increasing relationship between Walmart intensity and population density; this is to be expected since you would not expect to see Walmart stores in underpopulated areas. In the second plot, we note an inverse relationship between Walmart intensity and income---i.e. as an area's income increases, the Walmart intensity decreases.\n\nThe grey envelopes encompass the 95% confidence interval; i.e. the true estimate (black line) can fall anywhere within this envelope. Note how the envelope broadens near the upper end of the population density values--this suggests wide uncertainty in the estimated model.\n\nTo assess how well the above models explain the relationship between covariate and Walmart intensity, we will turn to hypothesis testing.\n\n## Testing for covariate effect\n\nNow, let's compare the non-homogeneous covariates to the null model using a technique called the *likelihood ratio* test. Remember that the null model assumes that the intensity is homogeneous across the entire study area; what we want to know is *\"does the model with the covariate do a significantly better job in predicting Walmart densities than the null model?\"*\n\n```{r}\nanova(Mo, Mpop, test = \"LRT\") # Compare null to population model\n```\n\n```{r}\nanova(Mo, Minc, test = \"LRT\") # Compare null to income model\n```\n\nWhat we are seeking is a small p-value (parameter `Pr(>Chi)` in the output). The smaller the value, the more confident we are in stating that the covariate does a better job in predicting Walmart intensity than the null model. For example, the p-value for the `Mpop` model (`Pr(>Chi) = 1.776e-08`) suggests that population density does a better job in predicting Walmart density than the null model `Mo`.\n\nThe p-value for `Minc`, on the other hand, is higher with a value of `Pr = 0.247` indicating that there is a 24.7% chance that we would be wrong in stating that income does a better job in predicting Walmart densities. To many, that probability is too high to reject the null.\n\nSo to summaries: of the two models we tested, it seems that population density does a better job at explaining the distribution of Walmarts (though not perfect) than the null model. Income distribution, on the other hand, does not improve on the null model.\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"PPM_analysis.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","theme":["cosmo","../custom.scss"],"title":"PPM: Exploring 1^st^ order effects","author":"Manny Gimond"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}